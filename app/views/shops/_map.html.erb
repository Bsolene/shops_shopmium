<div id="map" style="width: 100%; height: 70vh;" data-markers="<%= markers.to_json %>"></div>

<% content_for(:after_js) do %>
  <%= javascript_tag do %>

    var handler = Gmaps.build('Google');

    handler.buildMap({ internal: { id: 'map' } }, function() {

      if(navigator.geolocation)
        navigator.geolocation.getCurrentPosition(displayOnMap);


      markers = handler.addMarkers(<%= raw @hash.to_json %>);

    });

    function displayOnMap(position){
      var lat = position.coords.latitude
      var lng = position.coords.longitude
      var cords = lat + ',' + lng
      $('input[name="location"]').val(cords)

      var marker = handler.addMarker({
        lat: position.coords.latitude,
        lng: position.coords.longitude,
        picture: {
          url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
          width:  36,
          height: 36
        },

      });
      handler.bounds.extendWith(marker);
      handler.fitMapToBounds();
      handler.getMap().setZoom(12);
    };
  <% end %>
<% end %>
